const MEALS = [

/* =====================================================
   üí∏ ‚Ç±100‚Äì‚Ç±150
===================================================== */

// üîª LOSE (ORIGINAL)
{
    name: "Sardinas Guisado + Egg + Rice (W/Greens)",
    price: 111,
    calories: "420‚Äì480 kcal",
    protein: 28,
    carbs: 55,
    fat: 12,
    why: "Very affordable, high protein, omega-3 rich",
    ingredients: "Sardinas, egg, tomato, onion, pechay/kangkong, rice",
    recipe: "Saut√© tomato and onion, add sardines and vegetables.",
    goal: "lose",
    image: "./PNGS/8.jpg"
},
{
    name: "Tofu & Vegetable Stir-Fry + Egg + Rice",
    price: 111,
    calories: "420‚Äì480 kcal",
    protein: 28,
    carbs: 55,
    fat: 12,
    why: "Very affordable, high protein, omega-3 rich",
    ingredients: "Sardinas, egg, tomato, onion, pechay/kangkong, rice",
    recipe: "Saut√© tomato and onion, add sardines and vegetables. Crack egg and simmer. Serve with rice.",
    goal: "lose",
    image: "./PNGS/17.jpg"
},
{
    name: "Ginisang Monggo + Tofu + Rice",
    price: 115,
    calories: "400‚Äì450 kcal",
    protein: 22,
    carbs: 60,
    fat: 10,
    why: "High fiber, plant protein",
    ingredients: "Monggo, tofu, greens, rice",
    recipe: "Boil monggo, saut√© with tofu.",
    goal: "lose",
    image: "./PNGS/6.jpg"
},
{
    name: "Tofu & Vegetable Stir-Fry + Rice",
    price: 136,
    calories: "450‚Äì500 kcal",
    protein: 20,
    carbs: 65,
    fat: 12,
    why: "Balanced plant protein and vegetables",
    ingredients: "Tokwa, mixed vegetables, egg, garlic, onion, rice",
    recipe: "Stir-fry garlic and onion, add tofu and vegetables.",
    goal: "lose",
    image: "./PNGS/5.jpg"
},
{
    name: "Tofu & Vegetable Stir-Fry + Egg + Rice",
    price: 136,
    calories: "450‚Äì500 kcal",
    protein: 20,
    carbs: 65,
    fat: 12,
    why: "Balanced plant protein and vegetables",
    ingredients: "Tokwa, mixed vegetables, egg, garlic, onion, rice",
    recipe: "Stir-fry garlic and onion, add tofu and vegetables. Top with egg and serve with rice.",
    goal: "lose",
    image: "./PNGS/16.jpg"
},

// üîª LOSE (ADDED)
{
    name: "Ginisang Sayote + Egg + Rice (original)",
    price: 120,
    calories: "380‚Äì420 kcal",
    protein: 18,
    carbs: 55,
    fat: 9,
    goal: "lose",
    image: "./PNGS/8.jpg"
},

// ‚öñÔ∏è MAINTAIN (ADDED)
{
    name: "Tortang Talong + Rice",
    price: 130,
    calories: "450‚Äì500 kcal",
    protein: 18,
    carbs: 65,
    fat: 14,
    goal: "maintain",
    image: "./PNGS/19.jpg"
},
{
    name: "Itlog na Maalat + Kamatis + Rice",
    price: 120,
    calories: "450‚Äì480 kcal",
    protein: 16,
    carbs: 60,
    fat: 15,
    goal: "maintain",
    image: "./PNGS/20.jpg"
},
{
    name: "Ginisang Repolyo + Egg + Rice",
    price: 125,
    calories: "440‚Äì480 kcal",
    protein: 17,
    carbs: 60,
    fat: 13,
    goal: "maintain",
    image: "./PNGS/21.jpg"
},
{
    name: "Pritong Itlog + Saging + Rice",
    price: 110,
    calories: "460‚Äì500 kcal",
    protein: 15,
    carbs: 70,
    fat: 14,
    goal: "maintain",
    image: "./PNGS/22.jpg"
},
{
    name: "Ginisang Togue + Rice",
    price: 115,
    calories: "430‚Äì470 kcal",
    protein: 16,
    carbs: 60,
    fat: 12,
    goal: "maintain",
    image: "./PNGS/23.jpg"
},

// üî∫ GAIN (ADDED)
{
    name: "Egg Fried Rice (Homestyle)",
    price: 150,
    calories: "750‚Äì800 kcal",
    protein: 26,
    carbs: 85,
    fat: 30,
    goal: "gain",
    image: "./PNGS/24.jpg"
},
{
    name: "Hotdog Omelette + Rice",
    price: 135,
    calories: "680‚Äì720 kcal",
    protein: 28,
    carbs: 70,
    fat: 32,
    goal: "gain",
    image: "./PNGS/25.jpg"
},
{
    name: "Tortang Sardinas + Rice",
    price: 130,
    calories: "700‚Äì740 kcal",
    protein: 30,
    carbs: 65,
    fat: 35,
    goal: "gain",
    image: "./PNGS/26.jpg"
},
{
    name: "Pritong Tofu + Rice + Mayo",
    price: 145,
    calories: "720‚Äì760 kcal",
    protein: 24,
    carbs: 70,
    fat: 38,
    goal: "gain",
    image: "./PNGS/27.jpg"
},
{
    name: "Fried Egg + Rice + Peanut Butter",
    price: 140,
    calories: "650‚Äì700 kcal",
    protein: 22,
    carbs: 75,
    fat: 30,
    goal: "gain",
    image: "./PNGS/28.jpg"
},


/* =====================================================
   üí∏ ‚Ç±150‚Äì‚Ç±200
===================================================== */

// üîª LOSE (5)
{
    name: "Chicken Tinola + Rice",
    price: 190,
    calories: "450‚Äì500 kcal",
    protein: 35,
    carbs: 50,
    fat: 8,
    why: "Light soup meal, immune-boosting veggies",
    ingredients: "Chicken, papaya, malunggay, ginger, rice",
    recipe: "Simmer chicken with ginger, add vegetables.",
    goal: "lose",
    image: "./PNGS/7.jpg" // ORIGINAL
},
{
    name: "Nilagang Itlog + Ensaladang Pipino + Rice",
    price: 180,
    calories: "400‚Äì430 kcal",
    protein: 20,
    carbs: 55,
    fat: 10,
    goal: "lose",
    image: "./PNGS/29.jpg"
},
{
    name: "Tinolang Isda + Rice",
    price: 200,
    calories: "430‚Äì470 kcal",
    protein: 32,
    carbs: 55,
    fat: 9,
    goal: "lose",
    image: "./PNGS/30.jpg"
},
{
    name: "Inihaw na Tilapia + Rice",
    price: 200,
    calories: "450‚Äì480 kcal",
    protein: 38,
    carbs: 55,
    fat: 10,
    goal: "lose",
    image: "./PNGS/31.jpg"
},
{
    name: "Ginisang Ampalaya + Egg + Rice",
    price: 170,
    calories: "420‚Äì460 kcal",
    protein: 22,
    carbs: 55,
    fat: 10,
    goal: "lose",
    image: "./PNGS/32.jpg"
},

// ‚öñÔ∏è MAINTAIN (5)
{
    name: "Ginisang Sardinas + Rice",
    price: 190,
    calories: "580‚Äì620 kcal",
    protein: 30,
    carbs: 65,
    fat: 20,
    goal: "maintain",
    image: "./PNGS/33.jpg"
},
{
    name: "Chicken Omelette + Rice",
    price: 180,
    calories: "600‚Äì650 kcal",
    protein: 35,
    carbs: 60,
    fat: 22,
    goal: "maintain",
    image: "./PNGS/34.jpg"
},
{
    name: "Pritong Tilapia + Ensalada + Rice",
    price: 200,
    calories: "600‚Äì650 kcal",
    protein: 40,
    carbs: 65,
    fat: 20,
    goal: "maintain",
    image: "./PNGS/35.jpg"
},
{
    name: "Pork Giniling (Lean) + Rice",
    price: 200,
    calories: "620‚Äì660 kcal",
    protein: 34,
    carbs: 65,
    fat: 20,
    goal: "maintain",
    image: "./PNGS/36.jpg"
},
{
    name: "Chicken Guisado + Rice",
    price: 190,
    calories: "620‚Äì650 kcal",
    protein: 38,
    carbs: 68,
    fat: 18,
    goal: "maintain",
    image: "./PNGS/37.jpg"
},

// üî∫ GAIN (5)
{
    name: "Longganisa + Egg + Rice",
    price: 190,
    calories: "880‚Äì920 kcal",
    protein: 35,
    carbs: 80,
    fat: 45,
    goal: "gain",
    image: "./PNGS/38.jpg"
},
{
    name: "Corned Beef + Rice",
    price: 180,
    calories: "850‚Äì900 kcal",
    protein: 40,
    carbs: 70,
    fat: 42,
    goal: "gain",
    image: "./PNGS/39.jpg"
},
{
    name: "Pritong Manok (Leg Quarter) + Rice",
    price: 200,
    calories: "850‚Äì900 kcal",
    protein: 45,
    carbs: 75,
    fat: 40,
    goal: "gain",
    image: "./PNGS/40.jpg"
},
{
    name: "Chicken Fried Rice",
    price: 190,
    calories: "820‚Äì880 kcal",
    protein: 40,
    carbs: 90,
    fat: 32,
    goal: "gain",
    image: "./PNGS/41.jpg"
},
{
    name: "Pork Chop + Rice",
    price: 200,
    calories: "900‚Äì950 kcal",
    protein: 50,
    carbs: 70,
    fat: 45,
    goal: "gain",
    image: "./PNGS/42.jpg"
},


/* =====================================================
   üí∏ ‚Ç±300‚Äì‚Ç±400
===================================================== */

// üîª LOSE (‚Ç±300‚Äì‚Ç±400)
{
    name: "Chicken Breast Tinola + Rice",
    price: 350,
    calories: "450‚Äì500 kcal",
    protein: 42,
    carbs: 50,
    fat: 9,
    goal: "lose",
    image: "./PNGS/43.jpg"
},
{
    name: "Inihaw na Bangus (Small) + Rice",
    price: 380,
    calories: "480‚Äì520 kcal",
    protein: 40,
    carbs: 55,
    fat: 14,
    goal: "lose",
    image: "./PNGS/44.jpg"
},
{
    name: "Steamed Tilapia + Ensalada + Rice",
    price: 360,
    calories: "470‚Äì510 kcal",
    protein: 38,
    carbs: 55,
    fat: 10,
    goal: "lose",
    image: "./PNGS/45.jpg"
},


// ‚öñÔ∏è MAINTAIN (ORIGINAL)
{
    name: "Tuna Omelette + Rice + Saut√©ed Kangkong",
    price: 330,
    calories: "500‚Äì550 kcal",
    protein: 38,
    carbs: 55,
    fat: 15,
    why: "Omega-3 from tuna + protein from eggs",
    ingredients: "Tuna, eggs, rice, kangkong, garlic",
    recipe: "Cook omelette, saut√© kangkong, serve with rice.",
    goal: "maintain",
    image: "./PNGS/2.jpg"
},
{
    name: "Grilled Chicken Breast + Brown Rice + Steamed Veggies",
    price: 350,
    calories: "450‚Äì500 kcal",
    protein: 45,
    carbs: 50,
    fat: 8,
    why: "High protein, low fat, good fiber",
    ingredients: "Chicken breast (150g), brown rice, carrots, broccoli",
    recipe: "Grill chicken, cook rice, steam vegetables.",
    goal: "maintain",
    image: "./PNGS/1.jpg"
},
{
    name: "Pork Sinigang + Garlic Fried Rice + Ensalada",
    price: 360,
    calories: "700‚Äì750 kcal",
    protein: 45,
    carbs: 70,
    fat: 28,
    why: "Balanced comfort meal with vegetables and protein",
    ingredients: "Pork belly, tamarind, kangkong, okra, rice",
    recipe: "Cook pork sinigang, fry rice with garlic.",
    goal: "maintain",
    image: "./PNGS/11.jpg"
},
{
    name: "Grilled Bangus + Ensaladang Talong + Rice",
    price: 380,
    calories: "520‚Äì560 kcal",
    protein: 42,
    carbs: 55,
    fat: 18,
    why: "Good fats, heart-friendly fish",
    ingredients: "Bangus, eggplant, tomato, onion, rice",
    recipe: "Grill bangus, prepare eggplant salad.",
    goal: "maintain",
    image: "./PNGS/4.jpg"
},

// üî∫ GAIN (ORIGINAL)
{
    name: "Beef Kaldereta + Buttered Vegetables + Rice",
    price: 400,
    calories: "800‚Äì850 kcal",
    protein: 55,
    carbs: 75,
    fat: 32,
    why: "Rich in protein and calories for muscle gain",
    ingredients: "Beef, potatoes, carrots, bell pepper, tomato sauce, rice",
    recipe: "Simmer beef in kaldereta sauce with vegetables.",
    goal: "gain",
    image: "./PNGS/13.jpg"
},

/* =====================================================
   üí∏ ‚Ç±400‚Äì‚Ç±500
===================================================== */

// üîª LOSE (ORIGINAL)
{
    name: "Sinigang na Baboy + Rice",
    price: 408,
    calories: "600‚Äì650 kcal",
    protein: 38,
    carbs: 70,
    fat: 18,
    why: "Light sour soup with vegetables",
    ingredients: "Pork, sinigang mix, kangkong, okra, rice",
    recipe: "Boil pork with vegetables and sinigang mix.",
    goal: "lose",
    image: "./PNGS/11.jpg"
},
{
    name: "Paksiw na Galunggong + Rice",
    price: 461,
    calories: "600‚Äì650 kcal",
    protein: 35,
    carbs: 75,
    fat: 15,
    why: "Low-oil fish dish, budget-friendly",
    ingredients: "Galunggong, vinegar, garlic, ginger, rice",
    recipe: "Simmer fish in vinegar with garlic and ginger.",
    goal: "lose",
    image: "./PNGS/15.jpg"
},

// ‚öñÔ∏è MAINTAIN (ORIGINAL)
{
    name: "Chicken Afritada + Rice",
    price: 404,
    calories: "650‚Äì700 kcal",
    protein: 48,
    carbs: 72,
    fat: 20,
    why: "Balanced stew with vegetables",
    ingredients: "Chicken, tomato sauce, potato, carrots, rice",
    recipe: "Simmer chicken in tomato sauce with vegetables.",
    goal: "maintain",
    image: "./PNGS/3.jpg"
},
{
    name: "Adobong Sitaw + Sarciadong Galunggong + Rice",
    price: 450,
    calories: "650‚Äì700 kcal",
    protein: 35,
    carbs: 75,
    fat: 20,
    why: "Vegetables with fish protein",
    ingredients: "Sitaw, galunggong, eggs, tomato, onion, rice",
    recipe: "Cook sitaw adobo-style. Fry galunggong then simmer with egg and tomato.",
    goal: "maintain",
    image: "./PNGS/6.jpg"
},
{
    name: "Tinolang Manok + Tortang Dilis + Rice",
    price: 460,
    calories: "650‚Äì700 kcal",
    protein: 48,
    carbs: 65,
    fat: 18,
    why: "Protein-heavy Filipino comfort meal",
    ingredients: "Chicken, papaya, dilis, eggs, rice",
    recipe: "Cook tinola soup. Fry dilis omelette. Serve with rice.",
    goal: "maintain",
    image: "./PNGS/7.jpg"
},
{
    name: "Bangus Steak + Rice",
    price: 491,
    calories: "650‚Äì700 kcal",
    protein: 45,
    carbs: 65,
    fat: 24,
    why: "Heart-friendly fish meal",
    ingredients: "Bangus, soy sauce, calamansi, onion, rice",
    recipe: "Pan-fry bangus and simmer in soy-calamansi sauce.",
    goal: "maintain",
    image: "./PNGS/4.jpg"
},

// üî∫ GAIN (ORIGINAL)
{
    name: "Scrambled Egg + Hotdog + Tuyo + Rice",
    price: 494,
    calories: "750‚Äì800 kcal",
    protein: 42,
    carbs: 70,
    fat: 35,
    why: "High energy breakfast",
    ingredients: "Eggs, hotdog, tuyo, rice",
    recipe: "Cook all separately, serve together.",
    goal: "gain",
    image: "./PNGS/9.jpg"
},
{
    name: "Chicken Adobo + Rice",
    price: 479,
    calories: "650‚Äì700 kcal",
    protein: 50,
    carbs: 65,
    fat: 25,
    why: "Protein-rich classic",
    ingredients: "Chicken, soy sauce, vinegar, garlic, rice",
    recipe: "Simmer chicken in soy and vinegar until tender.",
    goal: "gain",
    image: "./PNGS/10.jpg"
},
{
    name: "Pork Steak + Rice",
    price: 499,
    calories: "700‚Äì750 kcal",
    protein: 52,
    carbs: 68,
    fat: 28,
    why: "High protein, calorie-dense meal",
    ingredients: "Pork, soy sauce, calamansi, onion, rice",
    recipe: "Marinate pork in soy and calamansi, pan-fry until tender.",
    goal: "gain",
    image: "./PNGS/14.jpg"
},
{
    name: "Baked Tuna + Rice",
    price: 496,
    calories: "600‚Äì650 kcal",
    protein: 38,
    carbs: 68,
    fat: 20,
    why: "High protein, omega-3 fats",
    ingredients: "Canned tuna, mayo, cheese, ketchup, rice",
    recipe: "Mix tuna with mayo and cheese, bake until golden. Serve with rice.",
    goal: "gain",
    image: "./PNGS/2.jpg"
}

];


        // Helper function to determine price tier
        function getPriceTier(price) {
            if (price <= 200) return { label: "‚Ç±", class: "low" };
            if (price <= 400) return { label: "‚Ç±‚Ç±", class: "mid" };
            return { label: "‚Ç±‚Ç±‚Ç±", class: "high" };
        }

        // Gender selection
        let selectedGender = 'male';
        const genderButtons = document.querySelectorAll('.gender-btn');
        
        genderButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                genderButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedGender = btn.dataset.gender;
            });
        });

        // Calculate button
        document.getElementById('calculateBtn').addEventListener('click', calculate);

        function calculate() {
            // Get values
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('age').value);
            const activity = parseFloat(document.getElementById('activity').value);
            const goal = document.getElementById('goal').value;
            const budget = parseFloat(document.getElementById('budget').value) || null;

            // Validate
            if (!weight || !height || !age || !activity || !goal) {
                alert('Please fill in all fields!');
                return;
            }

            if (weight < 20 || height < 100 || age < 10) {
                alert('Please enter valid values.');
                return;
            }

            // Calculate BMI
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);

            // Calculate BMR (Mifflin-St Jeor)
            let bmr;
            if (selectedGender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            // Calculate TDEE
            const tdee = bmr * activity;

            // Adjust for goal
            let targetCalories;
            if (goal === 'lose') {
                targetCalories = tdee - 500;
            } else if (goal === 'gain') {
                targetCalories = tdee + 300;
            } else {
                targetCalories = tdee;
            }

            // Ideal weight range
            const minIdealWeight = (18.5 * heightM * heightM).toFixed(1);
            const maxIdealWeight = (24.9 * heightM * heightM).toFixed(1);

            // Body fat estimation
            let bodyFat;
            if (selectedGender === 'male') {
                bodyFat = (1.20 * bmi) + (0.23 * age) - 16.2;
            } else {
                bodyFat = (1.20 * bmi) + (0.23 * age) - 5.4;
            }
            bodyFat = Math.max(3, Math.min(50, bodyFat));

            // Macros
            let proteinRatio, carbRatio, fatRatio;
            if (goal === 'lose') {
                proteinRatio = 0.35;
                fatRatio = 0.25;
                carbRatio = 0.40;
            } else if (goal === 'gain') {
                proteinRatio = 0.30;
                fatRatio = 0.25;
                carbRatio = 0.45;
            } else {
                proteinRatio = 0.30;
                fatRatio = 0.30;
                carbRatio = 0.40;
            }

            const protein = Math.round((targetCalories * proteinRatio) / 4);
            const carbs = Math.round((targetCalories * carbRatio) / 4);
            const fats = Math.round((targetCalories * fatRatio) / 9);

            // Water intake
            const water = (weight * 0.033).toFixed(1);

            // BMI Category
            let category, recommendations, showAlert;
            
            if (bmi < 16) {
                category = 'SEVERELY UNDERWEIGHT';
                showAlert = true;
                recommendations = [
                    'Consult a healthcare provider immediately',
                    'Increase calorie intake with nutrient-dense foods',
                    'Focus on strength training exercises',
                    'Consider nutritional supplements'
                ];
            } else if (bmi < 18.5) {
                category = 'UNDERWEIGHT';
                recommendations = [
                    'Increase calorie intake gradually',
                    'Eat frequent, nutrient-rich meals',
                    'Add healthy fats and proteins to diet',
                    'Consider consulting a nutritionist'
                ];
            } else if (bmi < 25) {
                category = 'NORMAL WEIGHT';
                recommendations = [
                    'Maintain current healthy habits',
                    'Stay active with regular exercise',
                    'Continue balanced, nutritious meals',
                    'Get adequate sleep and hydration'
                ];
            } else if (bmi < 30) {
                category = 'OVERWEIGHT';
                recommendations = [
                    'Create a moderate calorie deficit',
                    'Increase physical activity gradually',
                    'Focus on whole foods and vegetables',
                    'Monitor portion sizes carefully'
                ];
            } else if (bmi < 35) {
                category = 'OBESE CLASS I';
                showAlert = true;
                recommendations = [
                    'Consult a healthcare provider',
                    'Create a structured weight loss plan',
                    'Start with low-impact exercises',
                    'Work with a nutrition professional'
                ];
            } else if (bmi < 40) {
                category = 'OBESE CLASS II';
                showAlert = true;
                recommendations = [
                    'Seek medical guidance immediately',
                    'Follow a supervised weight loss program',
                    'Regular health monitoring essential',
                    'Consider medical weight loss options'
                ];
            } else {
                category = 'OBESE CLASS III';
                showAlert = true;
                recommendations = [
                    'Urgent medical consultation required',
                    'Comprehensive health evaluation needed',
                    'Medical intervention may be necessary',
                    'Follow supervised treatment program'
                ];
            }

            // BMI position for indicator (15 to 40 range)
            const bmiPosition = Math.min(100, Math.max(0, ((bmi - 15) / 25) * 100));

            // Display results
            displayResults({
                bmi: bmi.toFixed(1),
                category,
                bmiPosition,
                bmr: Math.round(bmr),
                tdee: Math.round(tdee),
                targetCalories: Math.round(targetCalories),
                minIdealWeight,
                maxIdealWeight,
                bodyFat: bodyFat.toFixed(1),
                protein,
                carbs,
                fats,
                water,
                recommendations,
                showAlert,
                goal,
                budget
            });
        }

        function pickRandomMeal(goal, budget = null) {
            let matches = MEALS.filter(m => m.goal === goal);
            
            if (budget !== null) {
                matches = matches.filter(m => m.price <= budget);
            }
            
            if (matches.length === 0) return null;
            return matches[Math.floor(Math.random() * matches.length)];
        }

        function generateWeeklyPlan(goal, budget) {
            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            const plan = [];
            let totalCost = 0;

            days.forEach(day => {
                const breakfast = pickRandomMeal(goal, budget);
                const lunch = pickRandomMeal(goal, budget);
                const dinner = pickRandomMeal(goal, budget);
                
                const dayCost = (breakfast?.price || 0) + (lunch?.price || 0) + (dinner?.price || 0);
                totalCost += dayCost;

                plan.push({
                    day,
                    breakfast,
                    lunch,
                    dinner,
                    total: dayCost
                });
            });

            return { plan, totalCost };
        }

        function sendToGmail() {
            const email = document.getElementById('emailInput').value;
            if (!email) {
                alert('Please enter an email address!');
                return;
            }

            // Get the weekly plan data from window object (stored during display)
            if (!window.weeklyPlanText) {
                alert('Please generate a meal plan first!');
                return;
            }

            // Use mailto: protocol to open default email client
            const subject = 'My Weekly Meal Plan - MealMate';
            const body = window.weeklyPlanText;
            
            window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function displayResults(data) {
            const initialMessage = document.getElementById('initialMessage');
            const resultsDiv = document.getElementById('results');

            initialMessage.style.display = 'none';

            const goalText = data.goal === 'lose' ? 'Weight Loss' : 
                           data.goal === 'gain' ? 'Muscle Gain' : 'Weight Maintenance';

            let html = `
                <div class="bmi-display">
                    <div class="bmi-category">${data.category}</div>
                    <div class="bmi-value">${data.bmi}</div>
                    <div class="bmi-label">Body Mass Index</div>
                    
                    <div class="bmi-bar-container">
                        <div class="bmi-bar">
                            <div class="bmi-indicator" style="left: ${data.bmiPosition}%;"></div>
                        </div>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <label>BMR</label>
                        <value>${data.bmr} <span class="unit">kcal/day</span></value>
                    </div>
                    <div class="metric-card">
                        <label>TDEE</label>
                        <value>${data.tdee} <span class="unit">kcal/day</span></value>
                    </div>
                    <div class="metric-card">
                        <label>Target (${goalText})</label>
                        <value>${data.targetCalories} <span class="unit">kcal/day</span></value>
                    </div>
                    <div class="metric-card">
                        <label>Body Fat</label>
                        <value>${data.bodyFat} <span class="unit">%</span></value>
                    </div>
                    <div class="metric-card">
                        <label>Ideal Weight</label>
                        <value>${data.minIdealWeight}-${data.maxIdealWeight} <span class="unit">kg</span></value>
                    </div>
                    <div class="metric-card">
                        <label>Water Intake</label>
                        <value>${data.water} <span class="unit">liters/day</span></value>
                    </div>
                </div>

                <div class="macros-section">
                    <h2>üçΩÔ∏è DAILY MACROS</h2>
                    <div class="macros-grid">
                        <div class="macro-card">
                            <div class="macro-name">PROTEIN</div>
                            <div class="macro-value">${data.protein}</div>
                            <div class="macro-unit">grams/day</div>
                        </div>
                        <div class="macro-card">
                            <div class="macro-name">CARBS</div>
                            <div class="macro-value">${data.carbs}</div>
                            <div class="macro-unit">grams/day</div>
                        </div>
                        <div class="macro-card">
                            <div class="macro-name">FATS</div>
                            <div class="macro-value">${data.fats}</div>
                            <div class="macro-unit">grams/day</div>
                        </div>
                    </div>
                </div>
            `;

            if (data.showAlert) {
                html += `
                    <div class="health-alert">
                        <h3>‚ö†Ô∏è HEALTH ALERT</h3>
                        <p>Your BMI indicates a potential health concern. Please consult with a healthcare professional for personalized medical guidance and support.</p>
                    </div>
                `;
            }

            html += `
                <div class="recommendations-box">
                    <h3>üí° RECOMMENDATIONS</h3>
                    <ul>
                        ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            `;

            // Add meal recommendations section
            const recommendedMeals = MEALS.filter(meal => meal.goal === data.goal);
            
            // Filter by budget if provided
            const budgetFilteredMeals = data.budget ? 
                recommendedMeals.filter(meal => meal.price <= data.budget) : 
                recommendedMeals;
            
            html += `
                <div class="meals-section">
                    <h2>üç¥ RECOMMENDED MEALS FOR YOU</h2>
                    <p>Based on your goal: <strong style="color: #b51f1f;">${goalText}</strong></p>
            `;

            if (data.budget) {
                html += `<div class="budget-info">üí∞ Budget: ‚Ç±${data.budget} per meal</div>`;
            }

            if (budgetFilteredMeals.length === 0) {
                html += `
                    <p style="color: #b51f1f; font-size: 16px; text-align: center; padding: 30px; background: #f8d7da; border-radius: 14px;">
                        ‚ö†Ô∏è No meals found within your ‚Ç±${data.budget} budget. Try increasing your budget or removing the budget filter.
                    </p>
                `;
            } else {
                html += `<div class="meal-grid">`;

                budgetFilteredMeals.forEach(meal => {
                    const tier = getPriceTier(meal.price);
                    // Fallback to a colored placeholder if image doesn't load
                    const fallbackImage = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23f4ad28" width="400" height="300"/%3E%3Ctext x="50%25" y="50%25" font-size="24" fill="white" text-anchor="middle" dy=".3em" font-family="Arial Black"%3E' + encodeURIComponent(meal.name.substring(0, 20) + '...') + '%3C/text%3E%3C/svg%3E';
                    
                    html += `
                        <div class="meal-card" onclick="this.classList.toggle('active')">
                            <img src="${meal.image}" alt="${meal.name}" 
                                 onerror="this.src='${fallbackImage}'">
                            <div class="meal-content">
                                <span class="price-tag ${tier.class}">${tier.label} ‚Ç±${meal.price}</span>
                                <h3>${meal.name}</h3>
                                <div class="meal-stats">
                                    <strong>Calories:</strong> ${meal.calories}<br>
                                    <strong>Protein:</strong> ${meal.protein}g | 
                                    <strong>Carbs:</strong> ${meal.carbs}g | 
                                    <strong>Fat:</strong> ${meal.fat}g
                                </div>
                                <div class="details">
                                    <p><strong>Why healthy:</strong> ${meal.why}</p>
                                    <p><strong>Ingredients:</strong> ${meal.ingredients}</p>
                                    <p><strong>Recipe:</strong> ${meal.recipe}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            html += `</div>`;

            // Generate Weekly Meal Plan
            const { plan, totalCost } = generateWeeklyPlan(data.goal, data.budget);
            
            html += `
                <div class="weekly-planner-section">
                    <h2>üìÖ WEEKLY MEAL PLAN</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Automatically generated meal plan based on your goal
                        ${data.budget ? ` and ‚Ç±${data.budget} budget per meal` : ''}
                    </p>
                    
                    <table class="weekly-table">
                        <tr>
                            <th>Day</th>
                            <th>Breakfast</th>
                            <th>Lunch</th>
                            <th>Dinner</th>
                            <th>Daily Total</th>
                        </tr>
            `;

            // Build email text version
            let emailText = `MEALMATE WEEKLY MEAL PLAN\n`;
            emailText += `================================\n\n`;
            emailText += `YOUR HEALTH PROFILE:\n`;
            emailText += `- BMI: ${data.bmi} (${data.category})\n`;
            emailText += `- Goal: ${goalText}\n`;
            emailText += `- Daily Calories: ${data.targetCalories} kcal\n`;
            emailText += `- Macros: ${data.protein}g protein, ${data.carbs}g carbs, ${data.fats}g fat\n`;
            if (data.budget) {
                emailText += `- Budget per meal: ‚Ç±${data.budget}\n`;
            }
            emailText += `\n================================\n\n`;

            plan.forEach(dayPlan => {
                const bClass = dayPlan.breakfast ? getPriceTier(dayPlan.breakfast.price).class : '';
                const lClass = dayPlan.lunch ? getPriceTier(dayPlan.lunch.price).class : '';
                const dClass = dayPlan.dinner ? getPriceTier(dayPlan.dinner.price).class : '';

                html += `
                    <tr>
                        <td><strong>${dayPlan.day}</strong></td>
                        <td class="weekly-${bClass}">
                            ${dayPlan.breakfast ? `${dayPlan.breakfast.name} <br><strong>(‚Ç±${dayPlan.breakfast.price})</strong>` : '‚Äî'}
                        </td>
                        <td class="weekly-${lClass}">
                            ${dayPlan.lunch ? `${dayPlan.lunch.name} <br><strong>(‚Ç±${dayPlan.lunch.price})</strong>` : '‚Äî'}
                        </td>
                        <td class="weekly-${dClass}">
                            ${dayPlan.dinner ? `${dayPlan.dinner.name} <br><strong>(‚Ç±${dayPlan.dinner.price})</strong>` : '‚Äî'}
                        </td>
                        <td style="text-align: center;"><strong>‚Ç±${dayPlan.total}</strong></td>
                    </tr>
                `;

                // Add to email text
                emailText += `${dayPlan.day.toUpperCase()}:\n`;
                emailText += `  Breakfast: ${dayPlan.breakfast ? dayPlan.breakfast.name + ' (‚Ç±' + dayPlan.breakfast.price + ')' : 'N/A'}\n`;
                emailText += `  Lunch: ${dayPlan.lunch ? dayPlan.lunch.name + ' (‚Ç±' + dayPlan.lunch.price + ')' : 'N/A'}\n`;
                emailText += `  Dinner: ${dayPlan.dinner ? dayPlan.dinner.name + ' (‚Ç±' + dayPlan.dinner.price + ')' : 'N/A'}\n`;
                emailText += `  Daily Total: ‚Ç±${dayPlan.total}\n\n`;
            });

            html += `
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>WEEKLY TOTAL:</strong></td>
                            <td style="text-align: center;"><strong>‚Ç±${totalCost}</strong></td>
                        </tr>
                    </table>

                    <div class="email-section">
                        <input type="email" id="emailInput" placeholder="Enter Gmail address" readonly>
                        <button onclick="sendToGmail()">SEND TO GMAIL</button>
                    </div>
                </div>
            `;

            emailText += `\n================================\n`;
            emailText += `Weekly Total: ‚Ç±${totalCost}\n`;
            emailText += `Average per day: ‚Ç±${(totalCost / 7).toFixed(2)}\n\n`;
            emailText += `Generated by MealMate - Your Health & Nutrition Planner\n`;

            // Store email text in window object for the send function
            window.weeklyPlanText = emailText;

            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');

            // Auto-fill email from localStorage
            autoFillUserEmail();

            // Smooth scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Function to auto-fill user email from localStorage
        function autoFillUserEmail() {
            try {
                const userData = localStorage.getItem('mealmate_current_user');
                if (userData) {
                    const user = JSON.parse(userData);
                    const emailInput = document.getElementById('emailInput');
                    if (emailInput && user.email) {
                        emailInput.value = user.email;
                    }
                }
            } catch (error) {
                console.log('Could not auto-fill email:', error);
            }
        }



// Navbar scroll behavior - show nav links after scrolling
window.addEventListener('scroll', () => {
    const nav = document.getElementById('mainNav');
    if (window.scrollY > 100) {
        nav.classList.add('scrolled');
    } else {
        nav.classList.remove('scrolled');
    }
});

// Search toggle functionality (only if search button exists)
const searchBtn = document.getElementById('searchBtn');
if (searchBtn) {
    searchBtn.addEventListener('click', () => {
        document.getElementById('mainNav').classList.toggle('search-open');
    });
}



// ==================== USER PROFILE MANAGEMENT ====================
    function loadUserProfile() {
        // üîç DEBUG: Check localStorage status
        console.log('%c=== MEALMATE DEBUG INFO ===', 'background: #FFB800; color: #B80000; font-weight: bold; padding: 5px;');
        console.log('Current URL:', window.location.href);
        console.log('Domain:', window.location.hostname);
        console.log('Protocol:', window.location.protocol);
        console.log('LocalStorage available:', typeof(Storage) !== "undefined");
        console.log('All localStorage keys:', Object.keys(localStorage));
        
        const userData = localStorage.getItem('mealmate_current_user');
        console.log('mealmate_current_user (raw):', userData);
        
        if (!userData || userData === 'undefined' || userData === 'null') {
            console.error('%c‚ùå NO USER DATA FOUND', 'color: red; font-weight: bold; font-size: 16px;');
            console.log('User will be redirected to login page in 2 seconds...');
            
            // Show alert to user
            alert('‚ö†Ô∏è No user session found. Please sign up or log in first.');
            
            // Redirect to login - try relative path first
            setTimeout(() => {
                window.location.href = '../../index.html';
            }, 2000);
            return;
        }

        try {
            const user = JSON.parse(userData);
            
            console.log('%c‚úÖ USER DATA LOADED SUCCESSFULLY', 'color: green; font-weight: bold;');
            console.log('User details:', {
                username: user.username,
                email: user.email,
                fullName: user.fullName,
                id: user.id
            });
            console.log('%c========================', 'color: #FFB800;');
            
            // Get initials from full name or username
            const initials = user.fullName 
                ? user.fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)
                : user.username.substring(0, 2).toUpperCase();
            
            // Update profile display
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('userName').textContent = user.fullName || user.username;
            
            // üéØ THE KEY FIX: Always use the real email if it exists
            const displayEmail = user.email || `${user.username}@mealmate.local`;
            document.getElementById('userEmail').textContent = displayEmail;
            
            console.log('Profile display updated with email:', displayEmail);
            
            document.getElementById('welcomeUser').textContent = user.fullName || user.username;
            
        } catch (e) {
            console.error('%c‚ùå ERROR PARSING USER DATA', 'color: red; font-weight: bold; font-size: 16px;');
            console.error('Parse error:', e);
            console.error('Raw data:', userData);
            
            alert('‚ö†Ô∏è Error loading user profile. Please log in again.');
            window.location.href = '../../index.html';
        }
    }

    function toggleProfileDropdown() {
        const dropdown = document.getElementById('profileDropdown');
        dropdown.classList.toggle('active');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const profile = document.getElementById('userProfile');
        const dropdown = document.getElementById('profileDropdown');
        
        if (!profile.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove('active');
        }
    });

    function viewProfile() {
        const userData = JSON.parse(localStorage.getItem('mealmate_current_user'));
        alert(`Profile Information:\n\nName: ${userData.fullName || userData.username}\nEmail: ${userData.email}\nJoined: ${new Date(userData.createdAt || userData.loginAt).toLocaleDateString()}`);
        toggleProfileDropdown();
    }

    function editProfile() {
        alert('Profile editing feature coming soon!');
        toggleProfileDropdown();
    }

    function viewSettings() {
        alert('Settings page coming soon!');
        toggleProfileDropdown();
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('mealmate_current_user');
            window.location.href = '../../index.html';
        }
    }

    // Load user profile on page load
    loadUserProfile();




     // ==================== ANIMATED BACKGROUND ====================
        const healthyFoods = ['ü•ó', 'ü•¶', 'üçé', 'ü•ï', 'ü•ë', 'üåΩ', 'ü´ê', 'ü•¨', 'üçä', 'ü•ù', 'ü•í', 'üßÖ', 'ü´í', 'ü•ê', 'üçû'];

        function initializeBackground() {
            const background = document.getElementById('foodBackground');
            
            for (let i = 0; i < 10; i++) {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.textContent = healthyFoods[i % healthyFoods.length];
                background.appendChild(foodItem);
            }

            setInterval(() => {
                const foodItems = document.querySelectorAll('.food-item');
                foodItems.forEach((item) => {
                    const newFood = healthyFoods[Math.floor(Math.random() * healthyFoods.length)];
                    item.textContent = newFood;
                });
            }, 4000);
        }

        // ==================== USER AUTHENTICATION ====================
        let isLogin = false;

        function validateForm() {
            let isValid = true;
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!isLogin) {
                const fullNameError = document.getElementById('fullNameError');
                if (fullName.trim().length < 2) {
                    fullNameError.textContent = 'Full name is required';
                    fullNameError.style.display = 'block';
                    isValid = false;
                } else {
                    fullNameError.style.display = 'none';
                }

                // Email validation
                const emailError = document.getElementById('emailError');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailError.textContent = 'Please enter a valid email';
                    emailError.style.display = 'block';
                    isValid = false;
                } else {
                    emailError.style.display = 'none';
                }
            }

            const usernameError = document.getElementById('usernameError');
            if (username.trim().length < 2) {
                usernameError.textContent = 'Username is required';
                usernameError.style.display = 'block';
                isValid = false;
            } else {
                usernameError.style.display = 'none';
            }

            const passwordError = document.getElementById('passwordError');
            if (password.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters';
                passwordError.style.display = 'block';
                isValid = false;
            } else {
                passwordError.style.display = 'none';
            }

            return isValid;
        }

        // ==================== FORM SUBMISSION ====================
        document.getElementById('authForm').addEventListener('submit', (e) => {
            e.preventDefault();

            if (!validateForm()) return;

            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!isLogin) {
                // Sign Up - Create user profile with real email
                const userProfile = {
                    id: Date.now(),
                    fullName: fullName,
                    username: username,
                    email: email, // Use the actual email entered by user
                    password: password,
                    createdAt: new Date().toISOString()
                };

                // Store in localStorage
                localStorage.setItem('mealmate_current_user', JSON.stringify(userProfile));
                
                const msg = document.getElementById('formMessage');
                msg.textContent = 'üéâ Account created! Redirecting...';
                msg.className = 'alert alert-success';

                setTimeout(() => {
                    window.location.href = 'MEALMEET/MEALMATE/mealmate.html';
                }, 1500);
            } else {
                // Login - Just redirect for demo purposes
                const userProfile = {
                    username: username,
                    fullName: username,
                    email: `${username}@mealmate.local`, // For login, keep auto-generated
                    loginAt: new Date().toISOString()
                };
                
                localStorage.setItem('mealmate_current_user', JSON.stringify(userProfile));
                
                const msg = document.getElementById('formMessage');
                msg.textContent = 'üçΩÔ∏è Welcome back! Redirecting...';
                msg.className = 'alert alert-success';

                setTimeout(() => {
                    window.location.href = 'MEALMEET/MEALMATE/mealmate.html';
                }, 1500);
            }
        });

        // ==================== TOGGLE FORM ====================
        function toggleForm() {
            isLogin = !isLogin;

            document.getElementById('fullNameField').style.display = isLogin ? 'none' : 'block';
            document.getElementById('emailField').style.display = isLogin ? 'none' : 'block';
            document.getElementById('formTitle').textContent = isLogin ? 'Sign In' : 'Sign Up';
            document.getElementById('submitText').textContent = isLogin ? 'Let\'s Eat!' : 'Let\'s Start!';
            document.getElementById('toggleText').textContent = isLogin ? 'New here?' : 'Got a seat?';
            document.getElementById('toggleLink').textContent = isLogin ? 'Sign up' : 'Sign in';
            document.getElementById('brandLeft').textContent = isLogin ? 'FOOD' : 'JOIN';
            document.getElementById('headline1').textContent = isLogin ? 'MORE' : 'LET\'S';
            document.getElementById('headline2').textContent = isLogin ? 'EASIER!' : 'START!';
            document.getElementById('brandRight').textContent = isLogin ? 'BUDGETING' : 'COOKING';

            document.getElementById('authForm').reset();
            document.getElementById('formMessage').classList.add('hidden');
        }

        // Initialize
        initializeBackground();
   